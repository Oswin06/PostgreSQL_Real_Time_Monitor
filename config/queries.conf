# PostgreSQL Monitor - Query Configuration File
# This file contains custom SQL queries that will be executed every second
# to monitor your PostgreSQL database and generate alerts.

# Query Configuration Format:
# [QueryID]
# name=Human readable name for the query
# sql=Your SQL query that returns results
# alert_type=critical|warning|info
# threshold=number (optional - for numeric results)
# enabled=true|false (optional)
# timeout=seconds (optional, default=5)

# ===== SECURITY MONITORING QUERIES =====

[SecurityBreach]
name=Security Breach Detection
sql=SELECT 'SECURITY BREACH DETECTED: ' || description as alert_message FROM security_events WHERE severity='HIGH' AND created_at > NOW() - INTERVAL '1 second'
alert_type=critical
enabled=true
timeout=5

[FailedLogins]
name=Failed Login Attempts
sql=SELECT CONCAT('Failed login attempts in last second: ', COUNT(*)) as alert_message FROM login_attempts WHERE success=false AND timestamp > NOW() - INTERVAL '1 second'
alert_type=warning
threshold=3
enabled=true
timeout=5

[SuspiciousActivity]
name=Suspicious Database Activity
sql=SELECT CONCAT('Suspicious activity detected from IP: ', client_addr) as alert_message FROM pg_stat_activity WHERE state = 'active' AND query LIKE '%password%' AND backend_start > NOW() - INTERVAL '1 second'
alert_type=warning
enabled=true
timeout=5

# ===== PERFORMANCE MONITORING QUERIES =====

[HighCPU]
name=High CPU Usage Alert
sql=SELECT CASE WHEN AVG(cpu_usage) > 80 THEN CONCAT('High CPU usage: ', ROUND(AVG(cpu_usage), 2), '%') ELSE 'Normal CPU usage' END as alert_message FROM system_metrics WHERE timestamp > NOW() - INTERVAL '1 second' AND metric_type='cpu'
alert_type=warning
threshold=1
enabled=false
timeout=5

[LongRunningQueries]
name=Long Running Queries
sql=SELECT CONCAT('Long running query detected: ', ROUND(EXTRACT(EPOCH FROM (NOW() - query_start)), 2), ' seconds') as alert_message FROM pg_stat_activity WHERE state = 'active' AND query_start < NOW() - INTERVAL '30 seconds' LIMIT 1
alert_type=warning
enabled=true
timeout=5

[DatabaseConnections]
name=Active Database Connections
sql=SELECT CONCAT('High connection count: ', COUNT(*), ' active connections') as alert_message FROM pg_stat_activity WHERE state = 'active' HAVING COUNT(*) > 20
alert_type=warning
threshold=20
enabled=true
timeout=5

# ===== RESOURCE MONITORING QUERIES =====

[LowDiskSpace]
name=Low Disk Space Warning
sql=SELECT CONCAT('Low disk space on database server: ', ROUND(100 * (pg_database_size(pg_database.datname) / 1024.0 / 1024.0 / 1024.0), 2), ' GB used') as alert_message FROM pg_database WHERE pg_database_size(pg_database.datname) / 1024.0 / 1024.0 / 1024.0 > 50 LIMIT 1
alert_type=warning
threshold=1
enabled=false
timeout=10

[HighMemoryUsage]
name=High Memory Usage
sql=SELECT CONCAT('High memory usage: ', ROUND(SUM(usage) / 1024.0, 2), ' MB') as alert_message FROM memory_stats WHERE timestamp > NOW() - INTERVAL '1 second' HAVING SUM(usage) > 2048
alert_type=warning
threshold=1
enabled=false
timeout=5

[DatabaseSizeGrowth]
name=Database Size Growth
sql=SELECT CONCAT('Database growing rapidly: ', ROUND(SUM(pg_database_size(datname)) / 1024.0 / 1024.0 / 1024.0, 2), ' GB total') as alert_message FROM pg_database HAVING SUM(pg_database_size(datname)) > 100 * 1024 * 1024 * 1024
alert_type=info
enabled=false
timeout=10

# ===== BUSINESS LOGIC QUERIES =====

[NewUsers]
name=New User Registrations
sql=SELECT CONCAT('New user registered: ', username, ' (', email, ')') as alert_message FROM users WHERE created_at > NOW() - INTERVAL '1 second'
alert_type=info
enabled=false
timeout=5

[LargeTransactions]
name=Large Transaction Volume
sql=SELECT CONCAT('High transaction volume: ', COUNT(*), ' transactions in last second') as alert_message FROM transaction_log WHERE timestamp > NOW() - INTERVAL '1 second'
alert_type=warning
threshold=100
enabled=false
timeout=5

[FailedPayments]
name=Payment Processing Failures
sql=SELECT CONCAT('Payment failures: ', COUNT(*), ' failed payments') as alert_message FROM payment_log WHERE status = 'failed' AND timestamp > NOW() - INTERVAL '1 second'
alert_type=critical
threshold=1
enabled=false
timeout=5

# ===== DATABASE HEALTH QUERIES =====

[TableLocks]
name=Table Lock Monitoring
sql=SELECT CONCAT('Table locks detected: ', COUNT(*), ' locks waiting') as alert_message FROM pg_locks WHERE granted = false AND NOT pid = pg_backend_pid()
alert_type=warning
threshold=5
enabled=true
timeout=5

[ReplicationLag]
name=Database Replication Lag
sql=SELECT CONCAT('Replication lag: ', EXTRACT(EPOCH FROM (NOW() - pg_last_xact_replay_timestamp())), ' seconds') as alert_message FROM pg_stat_replication LIMIT 1
alert_type=warning
threshold=30
enabled=false
timeout=5

[VacuumNeeded]
name=Table Maintenance Required
sql=SELECT CONCAT('VACUUM needed for table: ', schemaname||'.'||tablename, ' (', deadtuplecount, ' dead tuples)') as alert_message FROM pg_stat_user_tables WHERE deadtuplecount > 1000 LIMIT 1
alert_type=info
threshold=1
enabled=false
timeout=10

# ===== ERROR MONITORING QUERIES =====

[DatabaseErrors]
name=Database Error Log
sql=SELECT CONCAT('Database error: ', message) as alert_message FROM pg_error_log WHERE log_time > NOW() - INTERVAL '1 second' AND severity IN ('ERROR', 'FATAL', 'PANIC')
alert_type=critical
threshold=1
enabled=true
timeout=5

[ConnectionErrors]
name=Connection Pool Errors
sql=SELECT CONCAT('Connection errors: ', COUNT(*), ' failed connections') as alert_message FROM connection_log WHERE status = 'failed' AND timestamp > NOW() - INTERVAL '1 second'
alert_type=warning
threshold=3
enabled=false
timeout=5

[SlowQueries]
name=Slow Query Detection
sql=SELECT CONCAT('Slow query detected (', ROUND(EXTRACT(EPOCH FROM (NOW() - query_start)), 2), 's): ', LEFT(query, 100)) as alert_message FROM pg_stat_activity WHERE state = 'active' AND EXTRACT(EPOCH FROM (NOW() - query_start)) > 10 AND query_start > NOW() - INTERVAL '1 second' LIMIT 1
alert_type=warning
threshold=1
enabled=true
timeout=5

# ===== CUSTOM EXAMPLE QUERIES =====
# Uncomment and modify these examples for your specific use case

# [CustomAlert1]
# name=Your Custom Alert Name
# sql=SELECT CONCAT('Custom alert: ', COUNT(*), ' records found') as alert_message FROM your_table WHERE created_at > NOW() - INTERVAL '1 second'
# alert_type=info
# threshold=1
# enabled=false
# timeout=5

# [CustomAlert2]
# name=Another Custom Alert
# sql=SELECT 'Alert condition met' as alert_message FROM your_table WHERE condition = true AND timestamp > NOW() - INTERVAL '1 second' LIMIT 1
# alert_type=warning
# enabled=false
# timeout=5

# ===== CONFIGURATION NOTES =====
#
# 1. All queries should use the INTERVAL '1 second' pattern to only return
#    data from the last second, avoiding duplicate alerts.
#
# 2. Queries should return a single column named 'alert_message' for best results.
#    If multiple columns are returned, the first one will be used for the alert.
#
# 3. Use appropriate alert_type values:
#    - critical: Security breaches, system failures, high-severity issues
#    - warning: Performance issues, threshold breaches, medium-severity issues
#    - info: Normal operations, user activities, low-severity notifications
#
# 4. Set threshold for numeric results - if the returned number is >= threshold,
#    the alert will be generated. Otherwise, it will be ignored.
#
# 5. Set enabled=false to temporarily disable queries without removing them.
#
# 6. Keep queries efficient - they run every second and shouldn't impact database performance.